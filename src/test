<script>
  import { DataHandler, check } from '@vincjo/datatables'
  import Th from './Th.svelte';
  import Papa from 'papaparse';
  import ExportModal from './ExportModal.svelte';
  let consequences = [{description: 'dfasdfsfasdfsadd', type: 'Unintended', priority: 'High', outcome: 'Negative', AIM: 'Monitor'}, {description: 'dfdfasdfsdasdfsd', type: 'Unintended', priority: 'Low', outcome: 'Influence', AIM: 'Act'}, {description: 'dfdfasdfasdfsd', type: 'Unintended', priority: 'Low', outcome: 'Negative', AIM: 'Act'}, {description: 'dfadfasdsdfsd', type: 'Unintended', priority: 'Low', outcome: 'Negative', AIM: 'Act'}, {description: 'dfasdfsd', type: 'Unintended', priority: 'High', outcome: 'Negative', AIM: 'Act'}, {description: 'dfasdfsd', type: 'Unintended', priority: 'High', outcome: 'Negative', AIM: 'Act'}, {description: 'dfasdfsd', type: 'Unintended', priority: 'High', outcome: 'Negative', AIM: 'Act'}, {description: 'dfasdfsd', type: 'Intended', priority: 'Medium', outcome: 'Negative', AIM: 'Act'}]
  let showModal = false;

  

  const handler = new DataHandler(consequences);
  const filter = handler.createAdvancedFilter('AIM')
  const selected = filter.getSelected()
  const rows = handler.getRows();

let sections = [
{id:"Questions", visible: false},
{id:"Consequences", visible: false},
{id:"Review", visible: false},
{id:"Hypothesis", visible: false},
{id:"Categorization", visible: false}
]

function downloadCSV(data) {
    const csv = Papa.unparse(data);
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', window.URL.createObjectURL(blob));
    a.setAttribute('download', 'data.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

  function handleExport(columns) {
    console.log(columns);
    
    const csvData = hypotheses.map((hypothesis) => {
        let data = {};

        if (columns.includes("Hypothesis")) {
            data.Hypothesis = hypothesis.text;
        }

        if (columns.includes("Consequences")) {
            let consequencesStr = hypothesis.consequences.map((consequence) => {
                return `${consequence.description}, ${consequence.type}, ${consequence.priority}, ${consequence.outcome}, ${consequence.AIM}`;
            }).join(" | ")
            data.Consequences = consequencesStr;
        }

        if (columns.includes("Action")) {
            data.Action = hypothesis.action;
        }

        if (columns.includes("Measure")) {
            data.Measure = hypothesis.measure;
        }

        if (columns.includes("Timescale")) {
            data.Timescale = hypothesis.timescale;
        }

        return data;
    });

    downloadCSV(csvData);
    showModal = false;
}

    
  let selectedFile;
  let showPreLoadedOptions = false;
  let showQuestions = false;
  let showConsequences = false;
  let showReview = false;
  let showHypothesis = false;
  let showCategorization = false;
  let isAssigningActions = false
  let isViewingTable = false

  function viewTable() {
    isViewingTable = true;
  }
  function isChecked(index) {
    return selectedConsequencesIndices.includes(index);
  }

  function assignActions() {
    isAssigningActions = true;
  }

  function setActionForHypothesis(index, action) {
    hypotheses[index].action = action;
    console.log(`Action for hypothesis ${index}:`, action);
  }
  function setTimelineForHypothesis(index, timeline) {
    hypotheses[index].timeline = timeline;
    console.log(`timeline for hypothesis ${index}:`, timeline);
  }
  function setMeasureForHypothesis(index, measure) {
    hypotheses[index].measure = measure;
    console.log(`measure for hypothesis ${index}:`, measure);
  }

  let questionsSection;
  let consequencesSection;
  let reviewSection;


  let hypotheses = [];
  let hypothesisText = "";
  let currentHypothesisIndex = null;
  let selectedConsequencesIndices = [];
  function updateHypothesisConsequences() {
    const currentHypothesis = hypotheses[currentHypothesisIndex];
    currentHypothesis.consequences = selectedConsequencesIndices.map(
      (index) => consequences[index]
    );
    console.log("Updated hypothesis consequences:", currentHypothesis);
  }

  function attachConsequences() {
    hypotheses.push({ text: hypothesisText, consequences: [] });
    currentHypothesisIndex = hypotheses.length - 1;

    selectedConsequencesIndices = [];
  }

  function addAnotherHypothesis() {
    hypothesisText = "";
    currentHypothesisIndex = null;

    selectedConsequencesIndices = [];
  }

  function saveConsequences() {
    localStorage.setItem("consequences", JSON.stringify(consequences));
    showCategorization = true;
  }

  function saveCategorization() {
    localStorage.setItem("consequences", JSON.stringify(consequences));
    alert("Categorizations saved!");
  }

  const preLoadedStudies = ["Case Study 1", "Case Study 2", "Case Study 3"];
  let selectedStudy;

  let objectives = "";
  let stakeholders = "";
  let dataUsed = "";

  function uploadCaseStudy() {
    if (!selectedFile) {
      alert("No file selected!");
      return;
    }
    console.log(`Uploading ${selectedFile.name}...`);
    setTimeout(() => {
      console.log(`Successfully uploaded ${selectedFile.name}`);
      alert(`Successfully uploaded ${selectedFile.name}`);
    }, 2000);
    showQuestions = true;
  }

  function selectPreLoaded() {
    showPreLoadedOptions = true;
  }

  function confirmSelection(study) {
    selectedStudy = study;
    alert(`You have selected ${selectedStudy}`);
    showPreLoadedOptions = false;
    showQuestions = true;
  }
  function addConsequence() {
    consequences = [
      ...consequences,
      { description: "", type: "", outcome: "", priority: "", AIM: "" },
    ];
  }

  function toggleConsequence(index) {
    const idx = selectedConsequencesIndices.indexOf(index);

    if (idx === -1) {

      selectedConsequencesIndices.push(index);
    } else {

      selectedConsequencesIndices.splice(idx, 1);
    }
    updateHypothesisConsequences();
  }

  function done() {
    console.log(" Consequences:", consequences);
    localStorage.setItem("objectives", objectives);
    localStorage.setItem("stakeholders", stakeholders);
    localStorage.setItem("dataUsed", dataUsed);
    localStorage.setItem("Consequences", JSON.stringify(consequences));
    localStorage.setItem("categorized", JSON.stringify(categorized));
    reviewSection.scrollIntoView({ behavior: "smooth" });
  }
</script>

<!-- File Input for uploading a case study -->
<input
  type="file"
  bind:files={selectedFile}
  id="caseStudyFile"
  style="display:none;"
/>
<label for="caseStudyFile">
  <button
    on:click|preventDefault={() =>
      document.getElementById("caseStudyFile").click()}
    >Choose File to Upload</button
  >
</label>
{#if selectedFile}
  <p>Selected file: {selectedFile.name}</p>
  <button on:click={uploadCaseStudy}>Upload your case study</button>
{/if}

<!-- Button to select a pre-loaded case study -->
<button on:click={selectPreLoaded}
  >Choose from our pre-loaded case studies</button
>

<!-- Display pre-loaded case studies for selection -->
{#if showPreLoadedOptions}
  <ul>
    {#each preLoadedStudies as study}
      <li>
        <button on:click={() => confirmSelection(study)}>{study}</button>
      </li>
    {/each}
  </ul>
{/if}



<!-- Categorization -->
{#if showCategorization}
  <div class="card" id="Consequences">
    <h3>Consequences</h3>
    {#each consequences as consequence, i}
      <div class="consequence-options">
        <label for="description"
          >Consequence
          <textarea
            class="consequence-input"
            bind:value={consequence.description}
            placeholder="Description"
          />
        </label>
        <div class="input-row">
        <label for="type"
          >Intended/Unintended
          <select bind:value={consequence.type}>
            <option disabled selected value>Intended/Unintended</option>
            <option value="Intended">Intended</option>
            <option value="Unintended">Unintended</option>
          </select>
        </label>
        <label for="outcome"
          >Outcome
          <select bind:value={consequence.outcome}>
            <option disabled selected value>Outcome</option>
            <option value="Positive">Positive</option>
            <option value="Negative">Negative</option>
          </select>
        </label>
        <label for="priority"
          >Priority
          <select bind:value={consequence.priority}>
            <option disabled selected value>Priority</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </label>
        <label for="AIM"
          >Act/Influence/Monitor
          <select bind:value={consequence.AIM}>
            <option disabled selected value>Act, Influence, Monitor</option>
            <option value="Act">Act</option>
            <option value="Influence">Influence</option>
            <option value="Monitor">Monitor</option>
          </select>
        </label>
        </div>
      </div>
    {/each}
    <button on:click={addConsequence}>Add More</button>
    <div class="category-save-proceed">
      <button
        on:click={() => {
          saveCategorization();
          showReview = true;
        }}>Proceed to Review</button
      >
    </div>
  </div>
{/if}

{#if showReview}
  <div id="Review" class="card" bind:this={reviewSection}>
    <h1>Review</h1>
    <div class="long-text-review">
      <h2>Case Study: {selectedStudy}</h2>
      <hr />
      <h3>Objectives:</h3>
      <p>{objectives}</p>
      <h3>Stakeholders:</h3>
      <p>{stakeholders}</p>
      <h3>Data used:</h3>
      <p>{dataUsed}</p>
      <h3>Consequences</h3>
    </div>
    <!-- Act table -->
  <div class="filter-buttons">
    <button 
    on:click={() => filter.set('Act', check.isEqualTo)}
    class:active={$selected.includes('Act')}
>
    Act
</button>
<button 
on:click={() => filter.set('Monitor', check.isEqualTo)}
class:active={$selected.includes('Monitor')}
>
Monitor
</button>
<button 
on:click={() => filter.set('Influence', check.isEqualTo)}
class:active={$selected.includes('Influence')}
>
Influence
</button>
</div>
    <table>
      <thead>
        <tr>
          <Th {handler} orderBy="description">Consequence</Th>
          <Th {handler} orderBy="priority">Priority</Th>
          <Th {handler} orderBy="type">Type</Th>
          <Th {handler} orderBy="outcome">Outcome</Th>
          <Th {handler} orderBy="AIM">AIM</Th>
        </tr>
      </thead>
      <tbody>
        {#each $rows as row}
            <tr>
              <td>{row.description}</td>
              <td>{row.priority}</td>
              <td>{row.type}</td>
              <td>{row.outcome}</td>
              <td>{row.AIM}</td>
            </tr>
        {/each}
      </tbody>
    </table>
  </div>
  <!-- Button to print -->
  <button onclick="window.print()">Print this page</button>
  <button on:click={() => (showHypothesis = true)}>Proceed to hypothesis</button
  >
{/if}

{#if showHypothesis}
  <div class="card" id="Hypothesis">
    <h2>Input Hypothesis:</h2>
    <textarea bind:value={hypothesisText} />
    <button on:click={attachConsequences}>Attach Consequences</button>
  </div>
  <div class="card attach-hypothesis">
    {#if currentHypothesisIndex !== null}
      <!-- Displaying consequences to attach -->
      <h3>Consequences:</h3>
      <div class="consequences-checkbox">
        {#each consequences as consequence, i}
          <label class="checkbox-item">
            <input
              type="checkbox"
              checked={isChecked(i)}
              on:change={() => toggleConsequence(i)}
            />
            {consequence.description}
          </label>
        {/each}
      </div>
      <button on:click={addAnotherHypothesis}>Add another Hypothesis</button>
      <button on:click={assignActions}>Assign Actions</button>
    {/if}
  </div>
{/if}
{#if isAssigningActions}
  <div class="card">
    <h3>Assign Actions to Hypotheses:</h3>

    {#each hypotheses as hypothesis, i}
      <div class="long-text-review">
        <span class="hypothesis-actions-container"
          ><h4>Hypothesis {i}</h4>
          <p>{hypothesis.text}</p></span
        >
      </div>
      <div class="consequence-options">
        <label for="action">
          Action
          <textarea
            class="consequence-input"
            bind:value={hypothesis.action}
            placeholder="Enter action for this hypothesis"
            on:input={(event) => setActionForHypothesis(i, event.target.value)}
          />
        </label>
        <div class="input-row">
          <label for="timescale">Timescale
            <select bind:value={hypothesis.timescale}>
              <option disabled selected value>Timescale</option>
              <option value="3 months">3 months</option>
              <option value="6 months">6 months</option>
              <option value="1 year">1 year</option>
              <option value="2 years">2 years</option>
            </select>
          </label>
        <label for="measure">
          Measure
          <input
            class="consequence-input"
            type="text"
            bind:value={hypothesis.measure}
            placeholder="Enter measure for this hypothesis"
            on:input={(event) => setMeasureForHypothesis(i, event.target.value)}
          />
        </label>
      </div>
      </div>
    {/each}
  </div>
  <button on:click={viewTable}>View Data in Table Format</button>
{/if}

{#if isViewingTable}
  <table class="data-table">
    <thead>
      <tr>
        <th>Hypothesis</th>
        <th>Consequences</th>
        <th>Action</th>
        <th>Measure</th>
        <th>Timescale</th>
      </tr>
    </thead>
    <tbody>
      {#each hypotheses as hypothesis}
        <tr>
          <td>{hypothesis.text}</td>
          <td>
            {#each hypothesis.consequences as consequence}
              <div>{consequence.description} {consequence.type} {consequence.priority} {consequence.outcome} {consequence.AIM}</div>
            {/each}
          </td>
          <td>{hypothesis.action}</td>
          <td>{hypothesis.measure}</td>
          <td>{hypothesis.timescale}</td>
        </tr>
      {/each}
    </tbody>
  </table>
  <!-- The Modal -->
  <button on:click={() => { showModal = true; }}>Export CSV</button>
{/if}

{#if showModal}
  <ExportModal on:export={handleExport} />
{/if}
